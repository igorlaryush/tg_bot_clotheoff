# Настройка системы платежей StreamPay

## Обзор

Бот теперь поддерживает платежи через StreamPay API. Пользователи могут покупать пакеты обработки фото разного размера.

## Конфигурация пакетов

Пакеты настраиваются в файле `payment_packages.yaml`:

```yaml
packages:
  starter:
    name:
      en: "Starter Pack"
      ru: "Стартовый пакет"
    description:
      en: "Perfect for trying out the service"
      ru: "Идеально для знакомства с сервисом"
    photos: 5
    price: 2.99
    currency: "USD"
    popular: false
```

## Переменные окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# StreamPay Configuration
STREAMPAY_API_URL=https://api.streampay.org
STREAMPAY_STORE_ID=ваш_store_id
STREAMPAY_PRIVATE_KEY=ваш_private_key_в_hex
STREAMPAY_PUBLIC_KEY=ваш_public_key_в_hex
```

## Получение ключей StreamPay

1. Зарегистрируйтесь на https://streampay.org
2. Создайте магазин и получите Store ID
3. Сгенерируйте пару ключей (приватный и публичный)
4. Конвертируйте ключи в hex формат

## Webhook URL

StreamPay будет отправлять callback'и на:
```
https://ваш-домен.com/payment/callback
```

Убедитесь, что этот URL доступен и настроен в StreamPay.

## Страницы результатов

Бот автоматически создает страницы для результатов платежей:
- `/payment/success` - успешная оплата
- `/payment/fail` - неудачная оплата  
- `/payment/cancel` - отмененная оплата

## Команды бота

- `/balance` - показать баланс и купить фото
- `/start` - начать работу с ботом
- `/help` - помощь
- `/settings` - настройки

## Процесс оплаты

1. Пользователь отправляет фото без достаточного баланса
2. Бот предлагает купить пакет фото
3. Пользователь выбирает пакет и подтверждает
4. Создается инвойс в StreamPay
5. Пользователь оплачивает по ссылке
6. StreamPay отправляет callback
7. Бот начисляет фото на баланс
8. Пользователь получает уведомление

## База данных

Система создает следующие коллекции в Firestore:
- `users` - данные пользователей (включая `photos_balance`)
- `payment_orders` - заказы на оплату

## Безопасность

- Все callback'и от StreamPay проверяются цифровой подписью
- Приватные ключи хранятся в переменных окружения
- Используется временное окно для проверки подписей (2 минуты)

## Мониторинг

Логи включают:
- Создание заказов
- Обработку callback'ов
- Начисление фото
- Ошибки платежей

Проверяйте логи для отладки проблем с платежами. 